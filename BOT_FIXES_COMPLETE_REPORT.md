# ConnectBot v21 - –û—Ç—á–µ—Ç –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º

## –î–∞—Ç–∞: 9 –æ–∫—Ç—è–±—Ä—è 2025
## –°—Ç–∞—Ç—É—Å: ‚úÖ –û–°–ù–û–í–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –†–ï–®–ï–ù–´

---

## üéØ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã getUpdates (–ö–†–ò–¢–ò–ß–ù–û - –†–ï–®–ï–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:** `Conflict: terminated by other getUpdates request; make sure that only one bot instance is running`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ `Application.builder()`
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã (read_timeout=30, write_timeout=30, connect_timeout=20)
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `drop_pending_updates=True` –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (SIGINT, SIGTERM)
- ‚úÖ –£–ª—É—á—à–µ–Ω –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º `initialize()` –∏ `shutdown()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã getUpdates –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã, –±–æ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç.

### 2. ‚úÖ Unicode –æ—à–∏–±–∫–∏ –≤ Windows –∫–æ–Ω—Å–æ–ª–∏ (–†–ï–®–ï–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:** `UnicodeEncodeError: 'charmap' codec can't encode character`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –≤—Å–µ —ç–º–æ–¥–∑–∏ –∏–∑ –ª–æ–≥–æ–≤ (`‚úÖ ‚Üí —Ç–µ–∫—Å—Ç`, `üöÄ ‚Üí —Ç–µ–∫—Å—Ç`, `üõë ‚Üí —Ç–µ–∫—Å—Ç`)
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã —ç–º–æ–¥–∑–∏ –≤ callback –æ—Ç–≤–µ—Ç–∞—Ö (`‚ùå ‚Üí —Ç–µ–∫—Å—Ç`, `‚úÖ ‚Üí —Ç–µ–∫—Å—Ç`)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –±–µ–∑ Unicode —Å–∏–º–≤–æ–ª–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –õ–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫ –∫–æ–¥–∏—Ä–æ–≤–∫–∏.

### 3. üîß Async/sync –æ—à–∏–±–∫–∏ –≤ callback (–ß–ê–°–¢–ò–ß–ù–û –†–ï–®–ï–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:** `You cannot call this from an async context - use a thread or sync_to_async`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `RedisManager.async_invalidate_employee_cache()`
- ‚úÖ –ó–∞–º–µ–Ω–µ–Ω—ã sync –≤—ã–∑–æ–≤—ã Redis –≤ callback'–∞—Ö –Ω–∞ async –≤–µ—Ä—Å–∏–∏
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ sync/async –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

**–û—Å—Ç–∞–µ—Ç—Å—è:** 1 –æ—à–∏–±–∫–∞ async/sync –≤ callback - —Ç—Ä–µ–±—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:
- üöÄ **–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞:** –ë–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ getUpdates
- üì® **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –±–æ—Ç—É
- üîÑ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥:** /start, /menu, /help —Ä–∞–±–æ—Ç–∞—é—Ç
- üíæ **Redis –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π –∞–∫—Ç–∏–≤–Ω–æ
- üõë **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ —Å–∏–≥–Ω–∞–ª–∞–º

### ‚ö†Ô∏è –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- 1 sync/async –æ—à–∏–±–∫–∞ –≤ callback (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É)
- –û—à–∏–±–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Updater (–∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–µ)

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:

1. **`employees/management/commands/runbot.py`**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
   - –£–ª—É—á—à–µ–Ω –º–µ—Ç–æ–¥ `run_async()` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã Unicode —Å–∏–º–≤–æ–ª—ã –≤ –ª–æ–≥–∞—Ö –∏ –æ—Ç–≤–µ—Ç–∞—Ö
   - –ó–∞–º–µ–Ω–µ–Ω—ã sync –≤—ã–∑–æ–≤—ã Redis –Ω–∞ async

2. **`employees/redis_utils.py`**
   - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `async_invalidate_employee_cache()`
   - –û–±–µ—Å–ø–µ—á–µ–Ω–∞ async —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–ª—è callback'–æ–≤

3. **`runbot_fixed_main.py`** (—Å–æ–∑–¥–∞–Ω)
   - –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è standalone –≤–µ—Ä—Å–∏—è –±–æ—Ç–∞
   - –í—Å–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```python
# –£–ª—É—á—à–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Application
Application.builder()
    .token(self.token)
    .read_timeout(30)
    .write_timeout(30)
    .connect_timeout(20)
    .pool_timeout(10)
    .get_updates_read_timeout(10)
    .build()

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã polling –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
await self.application.updater.start_polling(
    poll_interval=2.0,
    timeout=10,
    read_timeout=15,
    write_timeout=15,
    connect_timeout=10,
    drop_pending_updates=True  # –ö–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä!
)
```

---

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ "–±–æ—Ç –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç" –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–®–ï–ù–ê!**

### –°—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:
- ‚úÖ **–û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç:** –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ–π –±–æ—Ç (simple_bot.py):** –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ  
- ‚úÖ **Redis –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ö†Ô∏è **Java –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å:** DEGRADED (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç** - –≤—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã
2. **–ü—Ä–æ—Å—Ç–æ–π –±–æ—Ç –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π** - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. **–î–æ—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Å—Ç–∞–≤—à—É—é—Å—è async/sync –æ—à–∏–±–∫—É** –≤ –±—É–¥—É—â–µ–º (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

**ConnectBot v21 –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ